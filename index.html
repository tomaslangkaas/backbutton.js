<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>backbutton.js tests</title>
    <style>
        body {
            font-family: sans-serif;
        }
    </style>
</head>

<body>
    <div id="testlog"></div>
    <script id="quicktest">
        function quicktest(title, tests, onprogress) {
            var pending = tests.length / 3,
                obj = {
                    'title': title,
                    'tests': tests,
                    'results': {},
                    'last': -1,
                    'passed': 0,
                    'failed': 0,
                    'completed': 0,
                    'pending': pending,
                    'total': pending,
                    'failures': {}
                };

            function isFunc(f) {
                return typeof(f) == 'function';
            }

            function defer(fn) {
                setTimeout(fn, 0);
            }

            function run(index) {
                var actual = tests[index + 1];
                if (isFunc(actual)) {
                    defer(function() {
                        try {
                            actual(function(testoutput) {
                                //defer(function(){
                                report(testoutput, index);
                                //});
                            });
                        } catch (err1) {
                            alert('err');
                            report(err1.message, index);
                        }
                    });
                } else {
                    defer(function() {
                        report(actual, index);
                    });
                }
            }

            function report(output, index) {
                var expected = tests[index + 2],
                    pass;
                pass = isFunc(expected) ? expected(output) : (output == expected);
                if (pass) {
                    obj.passed++;
                    obj.results[index] = 1;
                } else {
                    obj.failed++;
                    obj.failures[index] = output;
                    obj.results[index] = -1;
                }
                obj.last = index;
                obj.pending--;
                obj.completed++;
                onprogress(obj);
                if (obj.pending) run(index + 3);
            }
            defer(function() { //run tests
                //for(i = 0; i < tests.length; i+=3){
                run(0);
                //}
            });
            onprogress(obj);
        }

        var testReporter = (function(prefix) {
            var instanceId = 0;
            return function(parentID) {
                var id = instanceId++,
                    pre = prefix + id + '_';

                function elm(n, s) {
                    (document.getElementById(n) || {}).innerHTML = s;
                }
                return function(obj) {
                    if (obj.last < 0) { //init
                        var s = '<h2>' + obj.title + '</h2><p><span id="' + pre + 'c">' + obj.completed + '</span>' +
                            ' of ' + obj.total + ' completed: ' +
                            '<span style="color:green" id="' + pre + 'p">' + obj.passed + '</span> passed, ' +
                            '<span style="color:red" id="' + pre + 'f">' + obj.failed + '</span> failed.</p><table>',
                            i, l, t = obj.tests;
                        for (i = 0, l = t.length; i < l; i += 3) {
                            s += '<tr><td>' + (i / 3 + 1) + '.</td><td>' + t[i] + '</td><td id="' + pre + i + '"></td></tr>';
                        }
                        elm(parentID, s + '</table>');
                    } else {
                        var i = obj.last,
                            r = obj.results[i];
                        r = r > 0 ? '<span style="color:green">Passed</span>' : '<span style="color:red">Failed:</span> ' + obj.failures[i];
                        elm(pre + i, r);
                        elm(pre + 'c', obj.completed);
                        elm(pre + 'p', obj.passed);
                        elm(pre + 'f', obj.failed);
                    }
                }
            }
        })('testReporter');
    </script>
    <script>
        var min = false;

        if (!min) {

            var backbutton = (function(gwin) {
                function getFragment(url) {
                    url = url || gwin[LOC][HREF] || '';
                    var i = url.indexOf('#');
                    return i > -1 ? url.slice(i + 1) : '';
                }

                function setFragment(fragment, loct) {
                    (loct || gwin[LOC]).hash = '#' + fragment;
                }

                function poll() {
                    var current = getFragment(),
                        last = getFragment(iwindow[LOC][HREF]);
                    if (current != lastfrag) {
                        if (current != last) {
                            iwindoc = iwindow[DOC];
                            iwindoc.open();
                            iwindoc.close();
                            setFragment(current, iwindow[LOC]);
                        }
                        trigger(0, current);
                        lastfrag = current;
                    } else if (last != lastfrag) {
                        gwin[LOC][HREF] = gwin[LOC][HREF].replace(/#.*/, '#') + last;
                    }
                }

                function trigger(evt, fragment) {
                    var i, l = listeners.length;
                    fragment = fragment || getFragment();
                    router && router(fragment);
                    for (i = 0; i < l; i++) listeners[i](fragment);
                }
                var listeners = [],
                    DOC = 'document',
                    docm = gwin[DOC],
                    LOC = 'location',
                    HREF = 'href',
                    hashChangeSupport = ('onhashchange' in gwin) && gwin.addEventListener,
                    iFrame, iwindow, iwindoc,
                    router,
                    lastfrag = getFragment(),
                    methods = {
                        'observe': function(fn) {
                            listeners.push(fn);
                        },
                        'navigate': setFragment,
                        'current': getFragment,
                        'routes': function(arg, fallback) {
                            if (arg) {
                                router = function(str) {
                                    for (var i = 0, l = arg.length, m; i < l; i += 2) {
                                        if (m = str.match(arg[i])) {
                                            arg[i + 1].apply(null, m.slice(1));
                                            break;
                                        }
                                    }
                                    if (i == l && fallback) fallback(str);
                                }
                            } else {
                                router = 0;
                            }
                        },
                        'refresh': trigger,
                        'back': function() {
                            gwin.history.back();
                        }
                    };
                setFragment(lastfrag);
                if (hashChangeSupport) {
                    gwin.addEventListener('hashchange', trigger, false);
                } else {
                    iFrame = docm.createElement('iframe');
                    iFrame.src = 'javascript:0';
                    iFrame.style.display = 'none';
                    iFrame.tabIndex = -1;
                    iwindow = docm.body.insertBefore(iFrame, docm.body.firstChild).contentWindow;
                    iwindoc = iwindow[DOC];
                    iwindoc.open();
                    iwindoc.close();
                    setFragment(lastfrag, iwindow[LOC]);
                    setInterval(poll, 50);
                }
                return methods;
            })(window);

        } else {
            // < 1 kb

            var backbutton = function(b) {
                function k(a) {
                    a = a || b[d][m] || "";
                    var c = a.indexOf("#");
                    return -1 < c ? a.slice(c + 1) : ""
                }

                function n(a, c) {
                    (c || b[d]).hash = "#" + a
                }

                function v() {
                    var a = k(),
                        c = k(e[d][m]);
                    a != l ? (a != c && (g = e[p], g.open(), g.close(), n(a, e[d])), q(0, a), l = a) : c != l && (b[d][m] = b[d][m].replace(/#.*/, "#") + c)
                }

                function q(a, c) {
                    var b, f = r.length;
                    c = c || k();
                    t && t(c);
                    for (b = 0; b < f; b++) r[b](c)
                }
                var r = [],
                    p = "document",
                    u = b[p],
                    d = "location",
                    m = "href",
                    h = "onhashchange" in b && b.addEventListener,
                    e, g, t, l = k(),
                    w = {
                        observe: function(a) {
                            r.push(a)
                        },
                        navigate: n,
                        current: k,
                        routes: function(a, c) {
                            t = a ? function(b) {
                                for (var f = 0, d = a.length, e; f < d; f += 2)
                                    if (e = b.match(a[f])) {
                                        a[f + 1].apply(null, e.slice(1));
                                        break
                                    }
                                f == d && c && c(b)
                            } : 0
                        },
                        refresh: q,
                        back: function() {
                            b.history.back()
                        }
                    };
                n(l);
                h ? b.addEventListener("hashchange", q, !1) : (h = u.createElement("iframe"), h.src = "javascript:0", h.style.display = "none", h.tabIndex = -1, e = u.body.insertBefore(h, u.body.firstChild).contentWindow, g = e[p], g.open(), g.close(), n(l, e[d]), setInterval(v, 50));
                return w
            }(window);

        }

        //tests
        /*
        expected support:
        IE6+
        FF4+
        Op11/12+
        Sa5+

        */

        var observedFrag = '';
        backbutton.observe(function(frag) {
            observedFrag = frag;
        });

        var startFrag = backbutton.current() || '';
        var routesCalled = [];

        backbutton.routes([
            /^users\/(\w+)$/,
            function(section) {
                routesCalled.push('users/:' + section);
            },
            /^product\/(\d+)$/,
            function(productID) {
                routesCalled.push('product/:' + productID);
            }
        ]);

        quicktest('backbutton.js tests', [
                'backbutton.navigate("users/home")',
                function(done) {
                    backbutton.navigate("users/home");
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                },

                'backbutton.observe',
                '',
                function() {
                    return observedFrag == "users/home";
                },

                'route :param',
                '',
                function() {
                    return routesCalled.pop() == "users/:home";
                },

                'backbutton.navigate("product/1234")',
                function(done) {
                    backbutton.navigate("product/1234");
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "product/1234";
                },

                'backbutton.observe',
                '',
                function() {
                    return observedFrag == "product/1234";
                },

                'backbutton.back()',
                function(done) {
                    backbutton.back();
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                },

                'backbutton.observe',
                function(done) {
                    setTimeout(done, 100);
                },
                function() {
                    return observedFrag == "users/home";
                },

                'window.history.forward()',
                function(done) {
                    setTimeout(function() {
                        window.history.forward();
                        setTimeout(done, 100);
                    }, 100);
                },
                function() {
                    return backbutton.current() == "product/1234";
                },

                'observed frag',
                function(done) {
                    setTimeout(done, 100);
                },
                function() {
                    return observedFrag == "product/1234";
                },

                'backbutton.back()',
                function(done) {
                    backbutton.back();
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                },

                'backbutton.back()',
                function(done) {
                    backbutton.back();
                    setTimeout(done, 300);
                },
                function() {
                    //alert('routes called: '+routesCalled);
                    return backbutton.current() == startFrag;
                }
            ],
            testReporter('testlog')
        );
    </script>
</body>
</html>
