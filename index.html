<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>backbutton.js tests</title>
    <style>
        body {
            font-family: sans-serif;
        }
    </style>
</head>

<body>
    <div id="testlog"></div>
    <script src="quicktest.js">
    </script>
    <script src="backbutton.js">
    </script>
    <script>
        // Test setup //
        backbutton.navigate('');
        
        var observedFrag = '';
        backbutton.observe(function(frag) {
            observedFrag = frag;
        });

        var startFrag = backbutton.current() || '';
        var routesCalled = [];

        backbutton.routes([
            /^users\/(\w+)$/,
            function(section) {
                routesCalled.push('users/:' + section);
            },
            /^product\/(\d+)$/,
            function(productID) {
                routesCalled.push('product/:' + productID);
            }
        ]);

        // Tests //
        
        quicktest('backbutton.js tests', [
                'backbutton.navigate("users/home")',
                function(done) {
                    backbutton.navigate("users/home");
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                },

                'backbutton.observe',
                '',
                function() {
                    return observedFrag == "users/home";
                },

                'route :param',
                '',
                function() {
                    return routesCalled.pop() == "users/:home";
                },

                'backbutton.navigate("product/1234")',
                function(done) {
                    backbutton.navigate("product/1234");
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "product/1234";
                },

                'backbutton.observe',
                '',
                function() {
                    return observedFrag == "product/1234";
                },

                'backbutton.back()',
                function(done) {
                    backbutton.back();
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                },

                'backbutton.observe',
                function(done) {
                    setTimeout(done, 100);
                },
                function() {
                    return observedFrag == "users/home";
                },

                'window.history.forward()',
                function(done) {
                    setTimeout(function() {
                        window.history.forward();
                        setTimeout(done, 100);
                    }, 100);
                },
                function() {
                    return backbutton.current() == "product/1234";
                },

                'observed frag',
                function(done) {
                    setTimeout(done, 100);
                },
                function() {
                    return observedFrag == "product/1234";
                },

                'backbutton.back()',
                function(done) {
                    backbutton.back();
                    setTimeout(done, 100);
                },
                function() {
                    return backbutton.current() == "users/home";
                }
            ],
            testReporter('testlog')
        );
    </script>
</body>
</html>
